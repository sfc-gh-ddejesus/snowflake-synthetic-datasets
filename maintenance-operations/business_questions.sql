/*
 * Copyright 2024
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

-- Maintenance Operations - Business Analyst Questions and SQL Queries
-- 20+ Key Business Questions with Corresponding Analytical Queries
-- Optimized for Snowflake Data Cloud

USE DATABASE MAINTENANCE_OPERATIONS;
USE SCHEMA OPERATIONS;

-- =====================================================================
-- EQUIPMENT RELIABILITY & PERFORMANCE QUESTIONS
-- =====================================================================

-- 1. What is the equipment availability trend by equipment type across all facilities?
SELECT 
    e.EQUIPMENT_TYPE,
    e.FACILITY,
    DATE_TRUNC('month', wo.ACTUAL_START_DATE) as MONTH,
    COUNT(DISTINCT e.EQUIPMENT_ID) as EQUIPMENT_COUNT,
    COUNT(wo.WORK_ORDER_ID) as TOTAL_WORK_ORDERS,
    SUM(wo.DOWNTIME_HOURS) as TOTAL_DOWNTIME,
    AVG(CASE 
        WHEN SUM(wo.DOWNTIME_HOURS) IS NULL THEN 100
        ELSE (744 - COALESCE(SUM(wo.DOWNTIME_HOURS), 0)) / 744 * 100 
    END) as AVG_AVAILABILITY_PERCENT,
    AVG(wo.ACTUAL_COST) as AVG_MAINTENANCE_COST
FROM EQUIPMENT e
LEFT JOIN WORK_ORDERS wo ON e.EQUIPMENT_ID = wo.EQUIPMENT_ID AND wo.STATUS = 'COMPLETED'
WHERE wo.ACTUAL_START_DATE >= '2023-01-01' OR wo.ACTUAL_START_DATE IS NULL
GROUP BY e.EQUIPMENT_TYPE, e.FACILITY, DATE_TRUNC('month', wo.ACTUAL_START_DATE)
ORDER BY e.EQUIPMENT_TYPE, e.FACILITY, MONTH;

-- 2. Which equipment items are underperforming compared to their peer group based on MTTR?
WITH equipment_performance AS (
    SELECT 
        e.EQUIPMENT_ID,
        e.EQUIPMENT_NAME,
        e.EQUIPMENT_TYPE,
        e.CRITICALITY_LEVEL,
        COUNT(wo.WORK_ORDER_ID) as TOTAL_FAILURES,
        AVG(wo.ACTUAL_HOURS) as AVG_REPAIR_TIME,
        SUM(wo.DOWNTIME_HOURS) as TOTAL_DOWNTIME,
        SUM(wo.ACTUAL_COST) as TOTAL_COST
    FROM EQUIPMENT e
    JOIN WORK_ORDERS wo ON e.EQUIPMENT_ID = wo.EQUIPMENT_ID
    WHERE wo.STATUS = 'COMPLETED' 
    AND wo.ACTUAL_START_DATE >= DATEADD('month', -6, CURRENT_DATE())
    GROUP BY e.EQUIPMENT_ID, e.EQUIPMENT_NAME, e.EQUIPMENT_TYPE, e.CRITICALITY_LEVEL
),
equipment_benchmarks AS (
    SELECT 
        EQUIPMENT_TYPE,
        CRITICALITY_LEVEL,
        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY AVG_REPAIR_TIME) as MEDIAN_MTTR,
        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY AVG_REPAIR_TIME) as P75_MTTR
    FROM equipment_performance
    GROUP BY EQUIPMENT_TYPE, CRITICALITY_LEVEL
)
SELECT 
    ep.EQUIPMENT_NAME,
    ep.EQUIPMENT_TYPE,
    ep.CRITICALITY_LEVEL,
    ep.AVG_REPAIR_TIME,
    eb.MEDIAN_MTTR,
    ep.AVG_REPAIR_TIME - eb.MEDIAN_MTTR as MTTR_GAP,
    ROUND((ep.AVG_REPAIR_TIME / eb.MEDIAN_MTTR - 1) * 100, 2) as PERFORMANCE_PCT,
    ep.TOTAL_FAILURES,
    ep.TOTAL_COST
FROM equipment_performance ep
JOIN equipment_benchmarks eb ON ep.EQUIPMENT_TYPE = eb.EQUIPMENT_TYPE 
    AND ep.CRITICALITY_LEVEL = eb.CRITICALITY_LEVEL
WHERE ep.AVG_REPAIR_TIME > eb.MEDIAN_MTTR
ORDER BY PERFORMANCE_PCT DESC;

-- 3. What is the contribution of different failure modes to total maintenance cost?
SELECT 
    fc.FAILURE_CATEGORY,
    fc.FAILURE_DESCRIPTION,
    COUNT(DISTINCT wof.WORK_ORDER_ID) as OCCURRENCE_COUNT,
    SUM(wo.ACTUAL_COST) as TOTAL_REPAIR_COST,
    AVG(wo.ACTUAL_COST) as AVG_REPAIR_COST,
    SUM(wo.DOWNTIME_HOURS) as TOTAL_DOWNTIME,
    COUNT(DISTINCT e.EQUIPMENT_TYPE) as AFFECTED_EQUIPMENT_TYPES,
    ROUND((SUM(wo.ACTUAL_COST) / SUM(SUM(wo.ACTUAL_COST)) OVER ()) * 100, 2) as COST_CONTRIBUTION_PCT
FROM FAILURE_CODES fc
JOIN WORK_ORDER_FAILURES wof ON fc.FAILURE_CODE = wof.FAILURE_CODE
JOIN WORK_ORDERS wo ON wof.WORK_ORDER_ID = wo.WORK_ORDER_ID
JOIN EQUIPMENT e ON wo.EQUIPMENT_ID = e.EQUIPMENT_ID
WHERE wo.STATUS = 'COMPLETED'
AND wo.ACTUAL_START_DATE >= DATEADD('month', -12, CURRENT_DATE())
GROUP BY fc.FAILURE_CATEGORY, fc.FAILURE_DESCRIPTION
ORDER BY TOTAL_REPAIR_COST DESC;

-- =====================================================================
-- MAINTENANCE STRATEGY & EFFICIENCY QUESTIONS
-- =====================================================================

-- 4. What is the maintenance cost efficiency by technician certification level and specialization?
WITH technician_metrics AS (
    SELECT 
        t.TECHNICIAN_ID,
        t.CERTIFICATION_LEVEL,
        t.SPECIALIZATION,
        t.HOURLY_RATE,
        COUNT(DISTINCT woa.WORK_ORDER_ID) as WORK_ORDERS_COMPLETED,
        SUM(woa.HOURS_WORKED) as TOTAL_HOURS,
        SUM(woa.HOURS_WORKED * t.HOURLY_RATE) as TOTAL_LABOR_COST,
        AVG(wo.ACTUAL_HOURS) as AVG_HOURS_PER_JOB,
        AVG(wo.ESTIMATED_HOURS) as AVG_ESTIMATED_HOURS,
        SUM(wo.ACTUAL_COST) as TOTAL_JOB_COST
    FROM TECHNICIANS t
    JOIN WORK_ORDER_ASSIGNMENTS woa ON t.TECHNICIAN_ID = woa.TECHNICIAN_ID AND woa.ROLE = 'LEAD'
    JOIN WORK_ORDERS wo ON woa.WORK_ORDER_ID = wo.WORK_ORDER_ID
    WHERE wo.STATUS = 'COMPLETED'
    AND wo.ACTUAL_START_DATE >= DATEADD('month', -6, CURRENT_DATE())
    GROUP BY t.TECHNICIAN_ID, t.CERTIFICATION_LEVEL, t.SPECIALIZATION, t.HOURLY_RATE
)
SELECT 
    CERTIFICATION_LEVEL,
    SPECIALIZATION,
    COUNT(DISTINCT TECHNICIAN_ID) as TECHNICIAN_COUNT,
    AVG(WORK_ORDERS_COMPLETED) as AVG_WORK_ORDERS,
    AVG(TOTAL_HOURS) as AVG_TOTAL_HOURS,
    AVG(AVG_HOURS_PER_JOB) as AVG_HOURS_PER_JOB,
    AVG(TOTAL_LABOR_COST) as AVG_LABOR_COST,
    AVG(TOTAL_JOB_COST / WORK_ORDERS_COMPLETED) as AVG_COST_PER_JOB,
    AVG(AVG_HOURS_PER_JOB / NULLIF(AVG_ESTIMATED_HOURS, 0)) as AVG_EFFICIENCY_RATIO
FROM technician_metrics
GROUP BY CERTIFICATION_LEVEL, SPECIALIZATION
ORDER BY AVG_EFFICIENCY_RATIO;

-- 5. Which equipment has the highest propensity for emergency maintenance?
SELECT 
    e.EQUIPMENT_ID,
    e.EQUIPMENT_NAME,
    e.EQUIPMENT_TYPE,
    e.CRITICALITY_LEVEL,
    COUNT(wo.WORK_ORDER_ID) as TOTAL_WORK_ORDERS,
    COUNT(CASE WHEN wo.PRIORITY = 'EMERGENCY' THEN 1 END) as EMERGENCY_WORK_ORDERS,
    ROUND(COUNT(CASE WHEN wo.PRIORITY = 'EMERGENCY' THEN 1 END) * 100.0 / COUNT(wo.WORK_ORDER_ID), 2) as EMERGENCY_RATE,
    SUM(CASE WHEN wo.PRIORITY = 'EMERGENCY' THEN wo.ACTUAL_COST ELSE 0 END) as EMERGENCY_COST,
    AVG(CASE WHEN wo.PRIORITY = 'EMERGENCY' THEN wo.ACTUAL_COST END) as AVG_EMERGENCY_COST,
    SUM(CASE WHEN wo.PRIORITY = 'EMERGENCY' THEN wo.DOWNTIME_HOURS ELSE 0 END) as EMERGENCY_DOWNTIME
FROM EQUIPMENT e
JOIN WORK_ORDERS wo ON e.EQUIPMENT_ID = wo.EQUIPMENT_ID
WHERE wo.STATUS = 'COMPLETED'
AND wo.ACTUAL_START_DATE >= DATEADD('year', -1, CURRENT_DATE())
GROUP BY e.EQUIPMENT_ID, e.EQUIPMENT_NAME, e.EQUIPMENT_TYPE, e.CRITICALITY_LEVEL
HAVING COUNT(wo.WORK_ORDER_ID) >= 3
ORDER BY EMERGENCY_RATE DESC, EMERGENCY_COST DESC
LIMIT 20;

-- 6. What is the preventive vs reactive maintenance ratio and its impact on costs?
SELECT 
    e.EQUIPMENT_TYPE,
    e.CRITICALITY_LEVEL,
    CASE 
        WHEN MONTH(wo.ACTUAL_START_DATE) BETWEEN 1 AND 3 THEN 'Q1'
        WHEN MONTH(wo.ACTUAL_START_DATE) BETWEEN 4 AND 6 THEN 'Q2'
        WHEN MONTH(wo.ACTUAL_START_DATE) BETWEEN 7 AND 9 THEN 'Q3'
        ELSE 'Q4'
    END as QUARTER,
    COUNT(CASE WHEN mt.CATEGORY = 'PREVENTIVE' THEN 1 END) as PREVENTIVE_COUNT,
    COUNT(CASE WHEN mt.CATEGORY IN ('CORRECTIVE', 'EMERGENCY') THEN 1 END) as REACTIVE_COUNT,
    ROUND(COUNT(CASE WHEN mt.CATEGORY = 'PREVENTIVE' THEN 1 END) / 
        NULLIF(COUNT(CASE WHEN mt.CATEGORY IN ('CORRECTIVE', 'EMERGENCY') THEN 1 END), 0), 2) as PREVENTIVE_TO_REACTIVE_RATIO,
    SUM(CASE WHEN mt.CATEGORY = 'PREVENTIVE' THEN wo.ACTUAL_COST ELSE 0 END) as PREVENTIVE_COST,
    SUM(CASE WHEN mt.CATEGORY IN ('CORRECTIVE', 'EMERGENCY') THEN wo.ACTUAL_COST ELSE 0 END) as REACTIVE_COST,
    AVG(CASE WHEN mt.CATEGORY = 'PREVENTIVE' THEN wo.ACTUAL_COST END) as AVG_PREVENTIVE_COST,
    AVG(CASE WHEN mt.CATEGORY IN ('CORRECTIVE', 'EMERGENCY') THEN wo.ACTUAL_COST END) as AVG_REACTIVE_COST
FROM WORK_ORDERS wo
JOIN EQUIPMENT e ON wo.EQUIPMENT_ID = e.EQUIPMENT_ID
JOIN MAINTENANCE_TYPES mt ON wo.MAINTENANCE_TYPE_ID = mt.MAINTENANCE_TYPE_ID
WHERE wo.STATUS = 'COMPLETED' AND wo.ACTUAL_START_DATE >= '2023-01-01'
GROUP BY e.EQUIPMENT_TYPE, e.CRITICALITY_LEVEL, QUARTER
ORDER BY e.EQUIPMENT_TYPE, e.CRITICALITY_LEVEL, QUARTER;

-- =====================================================================
-- WORKFORCE PRODUCTIVITY & OPTIMIZATION QUESTIONS
-- =====================================================================

-- 7. What is the technician utilization rate and workload distribution?
WITH technician_workload AS (
    SELECT 
        t.TECHNICIAN_ID,
        t.FIRST_NAME || ' ' || t.LAST_NAME as TECHNICIAN_NAME,
        t.SPECIALIZATION,
        t.CERTIFICATION_LEVEL,
        COUNT(CASE WHEN wo.STATUS IN ('OPEN', 'IN_PROGRESS') THEN 1 END) as ACTIVE_WORK_ORDERS,
        SUM(CASE WHEN wo.STATUS IN ('OPEN', 'IN_PROGRESS') THEN wo.ESTIMATED_HOURS ELSE 0 END) as PENDING_HOURS,
        COUNT(CASE WHEN wo.STATUS = 'COMPLETED' AND wo.ACTUAL_START_DATE >= DATEADD('month', -1, CURRENT_DATE()) THEN 1 END) as COMPLETED_LAST_MONTH,
        SUM(CASE WHEN wo.STATUS = 'COMPLETED' AND wo.ACTUAL_START_DATE >= DATEADD('month', -1, CURRENT_DATE()) 
            THEN woa.HOURS_WORKED ELSE 0 END) as HOURS_LAST_MONTH
    FROM TECHNICIANS t
    LEFT JOIN WORK_ORDER_ASSIGNMENTS woa ON t.TECHNICIAN_ID = woa.TECHNICIAN_ID
    LEFT JOIN WORK_ORDERS wo ON woa.WORK_ORDER_ID = wo.WORK_ORDER_ID
    WHERE t.STATUS = 'ACTIVE'
    GROUP BY t.TECHNICIAN_ID, t.FIRST_NAME, t.LAST_NAME, t.SPECIALIZATION, t.CERTIFICATION_LEVEL
)
SELECT 
    TECHNICIAN_NAME,
    SPECIALIZATION,
    CERTIFICATION_LEVEL,
    ACTIVE_WORK_ORDERS,
    PENDING_HOURS,
    COMPLETED_LAST_MONTH,
    HOURS_LAST_MONTH,
    ROUND(HOURS_LAST_MONTH / 160.0 * 100, 2) as UTILIZATION_PERCENT, -- Assuming 160 hours per month
    CASE 
        WHEN PENDING_HOURS > 80 THEN 'OVERLOADED'
        WHEN PENDING_HOURS > 40 THEN 'BUSY'
        WHEN PENDING_HOURS > 0 THEN 'AVAILABLE'
        ELSE 'IDLE'
    END as WORKLOAD_STATUS
FROM technician_workload
ORDER BY UTILIZATION_PERCENT DESC;

-- 8. Which maintenance procedures have the highest time variance from estimates?
SELECT 
    mp.PROCEDURE_NAME,
    mp.EQUIPMENT_TYPE,
    mt.TYPE_NAME as MAINTENANCE_TYPE,
    mp.ESTIMATED_DURATION_HOURS as STANDARD_ESTIMATE,
    COUNT(wo.WORK_ORDER_ID) as TIMES_PERFORMED,
    AVG(wo.ACTUAL_HOURS) as AVG_ACTUAL_HOURS,
    AVG(wo.ESTIMATED_HOURS) as AVG_ESTIMATED_HOURS,
    AVG(wo.ACTUAL_HOURS) - mp.ESTIMATED_DURATION_HOURS as AVG_VARIANCE,
    STDDEV(wo.ACTUAL_HOURS) as TIME_VARIANCE,
    ROUND((AVG(wo.ACTUAL_HOURS) / NULLIF(mp.ESTIMATED_DURATION_HOURS, 0) - 1) * 100, 2) as VARIANCE_PERCENT,
    SUM(wo.ACTUAL_COST) as TOTAL_COST_IMPACT
FROM MAINTENANCE_PROCEDURES mp
JOIN MAINTENANCE_TYPES mt ON mp.MAINTENANCE_TYPE_ID = mt.MAINTENANCE_TYPE_ID
LEFT JOIN WORK_ORDERS wo ON mp.EQUIPMENT_TYPE = (
    SELECT EQUIPMENT_TYPE FROM EQUIPMENT WHERE EQUIPMENT_ID = wo.EQUIPMENT_ID
) AND wo.MAINTENANCE_TYPE_ID = mp.MAINTENANCE_TYPE_ID
WHERE wo.STATUS = 'COMPLETED'
AND wo.ACTUAL_START_DATE >= DATEADD('month', -6, CURRENT_DATE())
GROUP BY mp.PROCEDURE_NAME, mp.EQUIPMENT_TYPE, mt.TYPE_NAME, mp.ESTIMATED_DURATION_HOURS
HAVING COUNT(wo.WORK_ORDER_ID) >= 3
ORDER BY ABS(VARIANCE_PERCENT) DESC;

-- =====================================================================
-- PARTS & INVENTORY MANAGEMENT QUESTIONS
-- =====================================================================

-- 9. Which parts have the highest consumption rate and inventory turnover?
SELECT 
    p.PART_NAME,
    p.CATEGORY,
    p.MANUFACTURER,
    p.UNIT_COST,
    p.QUANTITY_ON_HAND,
    p.REORDER_POINT,
    COALESCE(SUM(wop.QUANTITY_USED), 0) as TOTAL_CONSUMED,
    COALESCE(SUM(wop.TOTAL_COST), 0) as TOTAL_COST_CONSUMED,
    COUNT(DISTINCT wop.WORK_ORDER_ID) as WORK_ORDERS_USED,
    ROUND(COALESCE(SUM(wop.TOTAL_COST), 0) / NULLIF(p.QUANTITY_ON_HAND * p.UNIT_COST, 0), 2) as TURNOVER_RATIO,
    CASE 
        WHEN p.QUANTITY_ON_HAND <= p.REORDER_POINT THEN 'REORDER_NOW'
        WHEN p.QUANTITY_ON_HAND <= p.REORDER_POINT * 1.5 THEN 'LOW_STOCK'
        ELSE 'ADEQUATE'
    END as STOCK_STATUS,
    ROUND(p.QUANTITY_ON_HAND / NULLIF(COALESCE(SUM(wop.QUANTITY_USED), 0) / 12.0, 0), 1) as MONTHS_OF_STOCK
FROM PARTS_INVENTORY p
LEFT JOIN WORK_ORDER_PARTS wop ON p.PART_ID = wop.PART_ID
LEFT JOIN WORK_ORDERS wo ON wop.WORK_ORDER_ID = wo.WORK_ORDER_ID 
    AND wo.ACTUAL_START_DATE >= DATEADD('year', -1, CURRENT_DATE())
GROUP BY p.PART_ID, p.PART_NAME, p.CATEGORY, p.MANUFACTURER, p.UNIT_COST, p.QUANTITY_ON_HAND, p.REORDER_POINT
ORDER BY TURNOVER_RATIO DESC;

-- 10. What is the maintenance cost breakdown by equipment type and age?
SELECT 
    e.EQUIPMENT_TYPE,
    CASE 
        WHEN DATEDIFF('year', e.INSTALLATION_DATE, CURRENT_DATE()) <= 2 THEN 'New (0-2 years)'
        WHEN DATEDIFF('year', e.INSTALLATION_DATE, CURRENT_DATE()) <= 5 THEN 'Mature (3-5 years)'
        WHEN DATEDIFF('year', e.INSTALLATION_DATE, CURRENT_DATE()) <= 10 THEN 'Aging (6-10 years)'
        ELSE 'Old (10+ years)'
    END as AGE_CATEGORY,
    COUNT(DISTINCT e.EQUIPMENT_ID) as EQUIPMENT_COUNT,
    COUNT(wo.WORK_ORDER_ID) as TOTAL_WORK_ORDERS,
    SUM(wo.ACTUAL_COST) as TOTAL_MAINTENANCE_COST,
    AVG(wo.ACTUAL_COST) as AVG_COST_PER_WORK_ORDER,
    SUM(wo.ACTUAL_COST) / COUNT(DISTINCT e.EQUIPMENT_ID) as COST_PER_EQUIPMENT,
    SUM(wop.TOTAL_COST) as TOTAL_PARTS_COST,
    SUM(wo.ACTUAL_COST) - COALESCE(SUM(wop.TOTAL_COST), 0) as TOTAL_LABOR_COST,
    AVG(e.REPLACEMENT_COST) as AVG_REPLACEMENT_COST,
    ROUND((SUM(wo.ACTUAL_COST) / COUNT(DISTINCT e.EQUIPMENT_ID)) / AVG(e.REPLACEMENT_COST) * 100, 2) as MAINTENANCE_TO_REPLACEMENT_RATIO
FROM EQUIPMENT e
LEFT JOIN WORK_ORDERS wo ON e.EQUIPMENT_ID = wo.EQUIPMENT_ID AND wo.STATUS = 'COMPLETED'
LEFT JOIN WORK_ORDER_PARTS wop ON wo.WORK_ORDER_ID = wop.WORK_ORDER_ID
WHERE wo.ACTUAL_START_DATE >= DATEADD('year', -1, CURRENT_DATE()) OR wo.ACTUAL_START_DATE IS NULL
GROUP BY e.EQUIPMENT_TYPE, AGE_CATEGORY
ORDER BY e.EQUIPMENT_TYPE, 
    CASE AGE_CATEGORY 
        WHEN 'New (0-2 years)' THEN 1 
        WHEN 'Mature (3-5 years)' THEN 2 
        WHEN 'Aging (6-10 years)' THEN 3 
        ELSE 4 
    END;

-- =====================================================================
-- PREDICTIVE MAINTENANCE & PLANNING QUESTIONS
-- =====================================================================

-- 11. Which equipment is approaching maintenance intervals and needs scheduling?
WITH equipment_intervals AS (
    SELECT 
        e.EQUIPMENT_ID,
        e.EQUIPMENT_NAME,
        e.EQUIPMENT_TYPE,
        e.CRITICALITY_LEVEL,
        MAX(CASE WHEN mt.CATEGORY = 'PREVENTIVE' THEN wo.ACTUAL_END_DATE END) as LAST_PREVENTIVE_DATE,
        COUNT(CASE WHEN mt.CATEGORY = 'PREVENTIVE' THEN 1 END) as PREVENTIVE_COUNT,
        AVG(CASE WHEN mt.CATEGORY = 'PREVENTIVE' 
            THEN DATEDIFF('day', LAG(wo.ACTUAL_END_DATE) OVER (PARTITION BY e.EQUIPMENT_ID, mt.CATEGORY ORDER BY wo.ACTUAL_END_DATE), wo.ACTUAL_END_DATE)
        END) as AVG_PREVENTIVE_INTERVAL
    FROM EQUIPMENT e
    LEFT JOIN WORK_ORDERS wo ON e.EQUIPMENT_ID = wo.EQUIPMENT_ID AND wo.STATUS = 'COMPLETED'
    LEFT JOIN MAINTENANCE_TYPES mt ON wo.MAINTENANCE_TYPE_ID = mt.MAINTENANCE_TYPE_ID
    WHERE e.STATUS = 'ACTIVE'
    GROUP BY e.EQUIPMENT_ID, e.EQUIPMENT_NAME, e.EQUIPMENT_TYPE, e.CRITICALITY_LEVEL
)
SELECT 
    EQUIPMENT_NAME,
    EQUIPMENT_TYPE,
    CRITICALITY_LEVEL,
    LAST_PREVENTIVE_DATE,
    COALESCE(AVG_PREVENTIVE_INTERVAL, 90) as RECOMMENDED_INTERVAL_DAYS,
    DATEDIFF('day', LAST_PREVENTIVE_DATE, CURRENT_DATE()) as DAYS_SINCE_LAST_PM,
    CASE 
        WHEN LAST_PREVENTIVE_DATE IS NULL THEN 'NEVER_SERVICED'
        WHEN DATEDIFF('day', LAST_PREVENTIVE_DATE, CURRENT_DATE()) > COALESCE(AVG_PREVENTIVE_INTERVAL, 90) * 1.2 THEN 'OVERDUE'
        WHEN DATEDIFF('day', LAST_PREVENTIVE_DATE, CURRENT_DATE()) > COALESCE(AVG_PREVENTIVE_INTERVAL, 90) * 0.9 THEN 'DUE_SOON'
        ELSE 'CURRENT'
    END as MAINTENANCE_STATUS,
    DATEADD('day', COALESCE(AVG_PREVENTIVE_INTERVAL, 90), LAST_PREVENTIVE_DATE) as NEXT_DUE_DATE
FROM equipment_intervals
WHERE EQUIPMENT_NAME NOT LIKE '%DECOMMISSIONED%'
ORDER BY 
    CASE WHEN LAST_PREVENTIVE_DATE IS NULL THEN 1
         WHEN DATEDIFF('day', LAST_PREVENTIVE_DATE, CURRENT_DATE()) > COALESCE(AVG_PREVENTIVE_INTERVAL, 90) * 1.2 THEN 2
         WHEN DATEDIFF('day', LAST_PREVENTIVE_DATE, CURRENT_DATE()) > COALESCE(AVG_PREVENTIVE_INTERVAL, 90) * 0.9 THEN 3
         ELSE 4 END,
    CRITICALITY_LEVEL,
    DAYS_SINCE_LAST_PM DESC;

-- 12. What is the failure pattern analysis for predictive maintenance opportunities?
WITH failure_patterns AS (
    SELECT 
        e.EQUIPMENT_TYPE,
        fc.FAILURE_CATEGORY,
        fc.FAILURE_DESCRIPTION,
        COUNT(wof.WORK_ORDER_ID) as FAILURE_COUNT,
        AVG(DATEDIFF('day', e.INSTALLATION_DATE, wo.ACTUAL_START_DATE)) as AVG_DAYS_TO_FAILURE,
        AVG(wo.ACTUAL_COST) as AVG_REPAIR_COST,
        AVG(wo.DOWNTIME_HOURS) as AVG_DOWNTIME,
        STRING_AGG(DISTINCT e.EQUIPMENT_NAME, ', ') as AFFECTED_EQUIPMENT
    FROM EQUIPMENT e
    JOIN WORK_ORDERS wo ON e.EQUIPMENT_ID = wo.EQUIPMENT_ID
    JOIN WORK_ORDER_FAILURES wof ON wo.WORK_ORDER_ID = wof.WORK_ORDER_ID
    JOIN FAILURE_CODES fc ON wof.FAILURE_CODE = fc.FAILURE_CODE
    WHERE wo.STATUS = 'COMPLETED'
    AND wo.ACTUAL_START_DATE >= DATEADD('year', -2, CURRENT_DATE())
    GROUP BY e.EQUIPMENT_TYPE, fc.FAILURE_CATEGORY, fc.FAILURE_DESCRIPTION
    HAVING COUNT(wof.WORK_ORDER_ID) >= 2
)
SELECT 
    EQUIPMENT_TYPE,
    FAILURE_CATEGORY,
    FAILURE_DESCRIPTION,
    FAILURE_COUNT,
    AVG_DAYS_TO_FAILURE,
    AVG_REPAIR_COST,
    AVG_DOWNTIME,
    ROUND(FAILURE_COUNT * AVG_REPAIR_COST, 2) as TOTAL_COST_IMPACT,
    CASE 
        WHEN AVG_DAYS_TO_FAILURE < 365 THEN 'HIGH_FREQUENCY'
        WHEN AVG_DAYS_TO_FAILURE < 730 THEN 'MEDIUM_FREQUENCY'
        ELSE 'LOW_FREQUENCY'
    END as FREQUENCY_CLASSIFICATION,
    AFFECTED_EQUIPMENT
FROM failure_patterns
ORDER BY TOTAL_COST_IMPACT DESC, FAILURE_COUNT DESC;

-- =====================================================================
-- OPERATIONAL EFFICIENCY & PERFORMANCE QUESTIONS
-- =====================================================================

-- 13. What is the overall equipment effectiveness (OEE) by facility and equipment type?
SELECT 
    e.FACILITY,
    e.EQUIPMENT_TYPE,
    COUNT(DISTINCT e.EQUIPMENT_ID) as EQUIPMENT_COUNT,
    -- Availability calculation
    AVG(CASE 
        WHEN SUM(wo.DOWNTIME_HOURS) IS NULL THEN 100
        ELSE (8760 - COALESCE(SUM(wo.DOWNTIME_HOURS), 0)) / 8760 * 100 
    END) as AVAILABILITY_PERCENT,
    -- Performance metrics
    SUM(COALESCE(wo.DOWNTIME_HOURS, 0)) as TOTAL_DOWNTIME_HOURS,
    SUM(COALESCE(wo.ACTUAL_COST, 0)) as TOTAL_MAINTENANCE_COST,
    COUNT(wo.WORK_ORDER_ID) as TOTAL_WORK_ORDERS,
    AVG(wo.ACTUAL_HOURS) as AVG_REPAIR_TIME,
    -- Quality indicators (inverse of failure rate)
    COUNT(CASE WHEN mt.CATEGORY IN ('CORRECTIVE', 'EMERGENCY') THEN 1 END) as REACTIVE_REPAIRS,
    COUNT(CASE WHEN mt.CATEGORY = 'PREVENTIVE' THEN 1 END) as PREVENTIVE_MAINTENANCE,
    ROUND(COUNT(CASE WHEN mt.CATEGORY = 'PREVENTIVE' THEN 1 END) * 100.0 / 
        NULLIF(COUNT(wo.WORK_ORDER_ID), 0), 2) as PREVENTIVE_RATIO
FROM EQUIPMENT e
LEFT JOIN WORK_ORDERS wo ON e.EQUIPMENT_ID = wo.EQUIPMENT_ID AND wo.STATUS = 'COMPLETED'
LEFT JOIN MAINTENANCE_TYPES mt ON wo.MAINTENANCE_TYPE_ID = mt.MAINTENANCE_TYPE_ID
WHERE e.STATUS = 'ACTIVE'
GROUP BY e.FACILITY, e.EQUIPMENT_TYPE
ORDER BY AVAILABILITY_PERCENT DESC, PREVENTIVE_RATIO DESC;

-- 14. What is the impact of maintenance timing on equipment performance?
WITH maintenance_timing AS (
    SELECT 
        e.EQUIPMENT_ID,
        e.EQUIPMENT_NAME,
        wo.WORK_ORDER_ID,
        wo.PRIORITY,
        mt.CATEGORY,
        wo.ACTUAL_START_DATE,
        wo.ACTUAL_COST,
        wo.DOWNTIME_HOURS,
        LAG(wo.ACTUAL_END_DATE) OVER (PARTITION BY e.EQUIPMENT_ID ORDER BY wo.ACTUAL_START_DATE) as PREV_MAINTENANCE_DATE,
        DATEDIFF('day', LAG(wo.ACTUAL_END_DATE) OVER (PARTITION BY e.EQUIPMENT_ID ORDER BY wo.ACTUAL_START_DATE), wo.ACTUAL_START_DATE) as DAYS_SINCE_LAST_MAINTENANCE
    FROM EQUIPMENT e
    JOIN WORK_ORDERS wo ON e.EQUIPMENT_ID = wo.EQUIPMENT_ID
    JOIN MAINTENANCE_TYPES mt ON wo.MAINTENANCE_TYPE_ID = mt.MAINTENANCE_TYPE_ID
    WHERE wo.STATUS = 'COMPLETED'
    AND wo.ACTUAL_START_DATE >= DATEADD('year', -1, CURRENT_DATE())
)
SELECT 
    CASE 
        WHEN DAYS_SINCE_LAST_MAINTENANCE IS NULL THEN 'FIRST_MAINTENANCE'
        WHEN DAYS_SINCE_LAST_MAINTENANCE <= 30 THEN '0-30_DAYS'
        WHEN DAYS_SINCE_LAST_MAINTENANCE <= 90 THEN '31-90_DAYS'
        WHEN DAYS_SINCE_LAST_MAINTENANCE <= 180 THEN '91-180_DAYS'
        ELSE '180+_DAYS'
    END as INTERVAL_BUCKET,
    CATEGORY as MAINTENANCE_TYPE,
    COUNT(*) as WORK_ORDER_COUNT,
    AVG(ACTUAL_COST) as AVG_COST,
    AVG(DOWNTIME_HOURS) as AVG_DOWNTIME,
    COUNT(CASE WHEN PRIORITY = 'EMERGENCY' THEN 1 END) as EMERGENCY_COUNT,
    ROUND(COUNT(CASE WHEN PRIORITY = 'EMERGENCY' THEN 1 END) * 100.0 / COUNT(*), 2) as EMERGENCY_RATE
FROM maintenance_timing
GROUP BY INTERVAL_BUCKET, CATEGORY
ORDER BY 
    CASE INTERVAL_BUCKET 
        WHEN 'FIRST_MAINTENANCE' THEN 1
        WHEN '0-30_DAYS' THEN 2
        WHEN '31-90_DAYS' THEN 3
        WHEN '91-180_DAYS' THEN 4
        ELSE 5 
    END,
    CATEGORY;

-- =====================================================================
-- COST OPTIMIZATION & ROI QUESTIONS
-- =====================================================================

-- 15. What is the ROI of preventive maintenance vs reactive repairs?
WITH maintenance_roi AS (
    SELECT 
        e.EQUIPMENT_TYPE,
        mt.CATEGORY as MAINTENANCE_STRATEGY,
        COUNT(wo.WORK_ORDER_ID) as WORK_ORDER_COUNT,
        SUM(wo.ACTUAL_COST) as TOTAL_COST,
        SUM(wo.DOWNTIME_HOURS) as TOTAL_DOWNTIME,
        AVG(wo.ACTUAL_COST) as AVG_COST_PER_WO,
        AVG(wo.DOWNTIME_HOURS) as AVG_DOWNTIME_PER_WO,
        SUM(wop.TOTAL_COST) as TOTAL_PARTS_COST,
        SUM(wo.ACTUAL_COST) - COALESCE(SUM(wop.TOTAL_COST), 0) as TOTAL_LABOR_COST
    FROM EQUIPMENT e
    JOIN WORK_ORDERS wo ON e.EQUIPMENT_ID = wo.EQUIPMENT_ID
    JOIN MAINTENANCE_TYPES mt ON wo.MAINTENANCE_TYPE_ID = mt.MAINTENANCE_TYPE_ID
    LEFT JOIN WORK_ORDER_PARTS wop ON wo.WORK_ORDER_ID = wop.WORK_ORDER_ID
    WHERE wo.STATUS = 'COMPLETED'
    AND wo.ACTUAL_START_DATE >= DATEADD('year', -1, CURRENT_DATE())
    GROUP BY e.EQUIPMENT_TYPE, mt.CATEGORY
)
SELECT 
    EQUIPMENT_TYPE,
    MAINTENANCE_STRATEGY,
    WORK_ORDER_COUNT,
    TOTAL_COST,
    TOTAL_DOWNTIME,
    AVG_COST_PER_WO,
    AVG_DOWNTIME_PER_WO,
    TOTAL_PARTS_COST,
    TOTAL_LABOR_COST,
    -- Assuming $1000/hour downtime cost
    TOTAL_COST + (TOTAL_DOWNTIME * 1000) as TOTAL_BUSINESS_IMPACT,
    ROUND((TOTAL_COST + (TOTAL_DOWNTIME * 1000)) / WORK_ORDER_COUNT, 2) as COST_PER_INCIDENT
FROM maintenance_roi
ORDER BY EQUIPMENT_TYPE, 
    CASE MAINTENANCE_STRATEGY 
        WHEN 'PREVENTIVE' THEN 1 
        WHEN 'PREDICTIVE' THEN 2 
        WHEN 'CORRECTIVE' THEN 3 
        ELSE 4 
    END;

-- 16. Which suppliers provide the best value parts based on reliability and cost?
WITH supplier_performance AS (
    SELECT 
        pi.MANUFACTURER as SUPPLIER,
        pi.CATEGORY,
        COUNT(DISTINCT pi.PART_ID) as PARTS_SUPPLIED,
        SUM(wop.QUANTITY_USED) as TOTAL_QUANTITY_USED,
        SUM(wop.TOTAL_COST) as TOTAL_SPENT,
        AVG(pi.UNIT_COST) as AVG_UNIT_COST,
        COUNT(DISTINCT wop.WORK_ORDER_ID) as WORK_ORDERS_SUPPORTED,
        -- Calculate reliability based on repeat usage
        SUM(wop.QUANTITY_USED) / COUNT(DISTINCT wop.WORK_ORDER_ID) as AVG_QUANTITY_PER_JOB,
        AVG(DATEDIFF('day', wo.ACTUAL_START_DATE, 
            LEAD(wo.ACTUAL_START_DATE) OVER (PARTITION BY wo.EQUIPMENT_ID ORDER BY wo.ACTUAL_START_DATE))) as AVG_DAYS_BETWEEN_FAILURES
    FROM PARTS_INVENTORY pi
    JOIN WORK_ORDER_PARTS wop ON pi.PART_ID = wop.PART_ID
    JOIN WORK_ORDERS wo ON wop.WORK_ORDER_ID = wo.WORK_ORDER_ID
    WHERE wo.STATUS = 'COMPLETED'
    AND wo.ACTUAL_START_DATE >= DATEADD('year', -1, CURRENT_DATE())
    GROUP BY pi.MANUFACTURER, pi.CATEGORY
    HAVING COUNT(DISTINCT pi.PART_ID) >= 2
)
SELECT 
    SUPPLIER,
    CATEGORY,
    PARTS_SUPPLIED,
    TOTAL_QUANTITY_USED,
    TOTAL_SPENT,
    AVG_UNIT_COST,
    WORK_ORDERS_SUPPORTED,
    ROUND(TOTAL_SPENT / WORK_ORDERS_SUPPORTED, 2) as COST_PER_WORK_ORDER,
    ROUND(AVG_DAYS_BETWEEN_FAILURES, 0) as AVG_RELIABILITY_DAYS,
    -- Value score (higher is better)
    ROUND((COALESCE(AVG_DAYS_BETWEEN_FAILURES, 90) / AVG_UNIT_COST) * 100, 2) as VALUE_SCORE
FROM supplier_performance
ORDER BY CATEGORY, VALUE_SCORE DESC;

-- =====================================================================
-- SEASONAL & TREND ANALYSIS QUESTIONS
-- =====================================================================

-- 17. How do maintenance patterns vary by season and what drives demand?
WITH seasonal_patterns AS (
    SELECT 
        e.EQUIPMENT_TYPE,
        e.LOCATION,
        CASE 
            WHEN MONTH(wo.ACTUAL_START_DATE) IN (12, 1, 2) THEN 'Winter'
            WHEN MONTH(wo.ACTUAL_START_DATE) IN (3, 4, 5) THEN 'Spring'
            WHEN MONTH(wo.ACTUAL_START_DATE) IN (6, 7, 8) THEN 'Summer'
            ELSE 'Fall'
        END as SEASON,
        COUNT(wo.WORK_ORDER_ID) as WORK_ORDER_COUNT,
        SUM(wo.ACTUAL_COST) as TOTAL_COST,
        AVG(wo.ACTUAL_HOURS) as AVG_REPAIR_TIME,
        SUM(wo.DOWNTIME_HOURS) as TOTAL_DOWNTIME,
        COUNT(CASE WHEN mt.CATEGORY = 'EMERGENCY' THEN 1 END) as EMERGENCY_COUNT
    FROM EQUIPMENT e
    JOIN WORK_ORDERS wo ON e.EQUIPMENT_ID = wo.EQUIPMENT_ID
    JOIN MAINTENANCE_TYPES mt ON wo.MAINTENANCE_TYPE_ID = mt.MAINTENANCE_TYPE_ID
    WHERE wo.STATUS = 'COMPLETED'
    AND wo.ACTUAL_START_DATE >= '2023-01-01'
    GROUP BY e.EQUIPMENT_TYPE, e.LOCATION, SEASON
)
SELECT 
    EQUIPMENT_TYPE,
    LOCATION,
    SEASON,
    WORK_ORDER_COUNT,
    TOTAL_COST,
    AVG_REPAIR_TIME,
    TOTAL_DOWNTIME,
    EMERGENCY_COUNT,
    AVG(WORK_ORDER_COUNT) OVER (PARTITION BY EQUIPMENT_TYPE, LOCATION) as ANNUAL_AVG,
    ROUND((WORK_ORDER_COUNT / AVG(WORK_ORDER_COUNT) OVER (PARTITION BY EQUIPMENT_TYPE, LOCATION) - 1) * 100, 2) as SEASONAL_INDEX
FROM seasonal_patterns
ORDER BY EQUIPMENT_TYPE, LOCATION, 
    CASE SEASON WHEN 'Winter' THEN 1 WHEN 'Spring' THEN 2 WHEN 'Summer' THEN 3 ELSE 4 END;

-- 18. What is the maintenance workload forecast for the next quarter?
WITH historical_patterns AS (
    SELECT 
        e.EQUIPMENT_TYPE,
        MONTH(wo.ACTUAL_START_DATE) as WORK_MONTH,
        COUNT(wo.WORK_ORDER_ID) as MONTHLY_WORK_ORDERS,
        SUM(wo.ACTUAL_HOURS) as MONTHLY_HOURS,
        SUM(wo.ACTUAL_COST) as MONTHLY_COST,
        AVG(wo.ACTUAL_HOURS) as AVG_HOURS_PER_WO
    FROM EQUIPMENT e
    JOIN WORK_ORDERS wo ON e.EQUIPMENT_ID = wo.EQUIPMENT_ID
    WHERE wo.STATUS = 'COMPLETED'
    AND wo.ACTUAL_START_DATE >= DATEADD('year', -1, CURRENT_DATE())
    GROUP BY e.EQUIPMENT_TYPE, MONTH(wo.ACTUAL_START_DATE)
),
forecast_months AS (
    SELECT 
        EQUIPMENT_TYPE,
        MONTH(DATEADD('month', seq, CURRENT_DATE())) as FORECAST_MONTH,
        DATEADD('month', seq, CURRENT_DATE()) as FORECAST_DATE
    FROM (SELECT DISTINCT EQUIPMENT_TYPE FROM EQUIPMENT) e
    CROSS JOIN (SELECT 1 as seq UNION SELECT 2 UNION SELECT 3) months
)
SELECT 
    fm.EQUIPMENT_TYPE,
    fm.FORECAST_MONTH,
    fm.FORECAST_DATE,
    ROUND(AVG(hp.MONTHLY_WORK_ORDERS), 0) as EXPECTED_WORK_ORDERS,
    ROUND(AVG(hp.MONTHLY_HOURS), 0) as EXPECTED_LABOR_HOURS,
    ROUND(AVG(hp.MONTHLY_COST), 0) as EXPECTED_COST,
    ROUND(AVG(hp.AVG_HOURS_PER_WO), 1) as EXPECTED_HOURS_PER_WO
FROM forecast_months fm
LEFT JOIN historical_patterns hp ON fm.EQUIPMENT_TYPE = hp.EQUIPMENT_TYPE 
    AND fm.FORECAST_MONTH = hp.WORK_MONTH
GROUP BY fm.EQUIPMENT_TYPE, fm.FORECAST_MONTH, fm.FORECAST_DATE
ORDER BY fm.EQUIPMENT_TYPE, fm.FORECAST_MONTH;

-- =====================================================================
-- COMPLIANCE & SAFETY QUESTIONS
-- =====================================================================

-- 19. What is the compliance rate for safety procedures and testing?
SELECT 
    mp.PROCEDURE_NAME,
    mp.EQUIPMENT_TYPE,
    mp.SKILL_LEVEL_REQUIRED,
    COUNT(wo.WORK_ORDER_ID) as PROCEDURES_PERFORMED,
    COUNT(CASE WHEN wo.STATUS = 'COMPLETED' THEN 1 END) as COMPLETED_PROCEDURES,
    ROUND(COUNT(CASE WHEN wo.STATUS = 'COMPLETED' THEN 1 END) * 100.0 / COUNT(wo.WORK_ORDER_ID), 2) as COMPLETION_RATE,
    AVG(wo.ACTUAL_HOURS) as AVG_COMPLETION_TIME,
    mp.ESTIMATED_DURATION_HOURS as STANDARD_TIME,
    ROUND((AVG(wo.ACTUAL_HOURS) / mp.ESTIMATED_DURATION_HOURS - 1) * 100, 2) as TIME_VARIANCE_PERCENT,
    COUNT(CASE WHEN wo.PRIORITY = 'EMERGENCY' THEN 1 END) as EMERGENCY_PROCEDURES,
    STRING_AGG(DISTINCT t.CERTIFICATION_LEVEL, ', ') as TECH_LEVELS_INVOLVED
FROM MAINTENANCE_PROCEDURES mp
LEFT JOIN WORK_ORDERS wo ON mp.MAINTENANCE_TYPE_ID = wo.MAINTENANCE_TYPE_ID
LEFT JOIN WORK_ORDER_ASSIGNMENTS woa ON wo.WORK_ORDER_ID = woa.WORK_ORDER_ID AND woa.ROLE = 'LEAD'
LEFT JOIN TECHNICIANS t ON woa.TECHNICIAN_ID = t.TECHNICIAN_ID
WHERE mp.PROCEDURE_NAME LIKE '%Safety%' OR mp.PROCEDURE_NAME LIKE '%Test%' OR mp.PROCEDURE_NAME LIKE '%Inspection%'
AND wo.ACTUAL_START_DATE >= DATEADD('month', -6, CURRENT_DATE())
GROUP BY mp.PROCEDURE_ID, mp.PROCEDURE_NAME, mp.EQUIPMENT_TYPE, mp.SKILL_LEVEL_REQUIRED, mp.ESTIMATED_DURATION_HOURS
ORDER BY COMPLETION_RATE DESC, PROCEDURES_PERFORMED DESC;

-- 20. Which equipment has the best maintenance ROI and lifecycle value?
WITH equipment_lifecycle AS (
    SELECT 
        e.EQUIPMENT_ID,
        e.EQUIPMENT_NAME,
        e.EQUIPMENT_TYPE,
        e.REPLACEMENT_COST,
        DATEDIFF('year', e.INSTALLATION_DATE, CURRENT_DATE()) as AGE_YEARS,
        COUNT(wo.WORK_ORDER_ID) as TOTAL_MAINTENANCE_EVENTS,
        SUM(wo.ACTUAL_COST) as TOTAL_MAINTENANCE_COST,
        SUM(wo.DOWNTIME_HOURS) as TOTAL_DOWNTIME_HOURS,
        AVG(wo.ACTUAL_COST) as AVG_COST_PER_EVENT,
        -- Calculate remaining useful life (assume 20 year lifecycle)
        GREATEST(20 - DATEDIFF('year', e.INSTALLATION_DATE, CURRENT_DATE()), 0) as REMAINING_YEARS,
        -- Availability calculation
        (8760 * DATEDIFF('year', e.INSTALLATION_DATE, CURRENT_DATE()) - COALESCE(SUM(wo.DOWNTIME_HOURS), 0)) / 
        NULLIF(8760 * DATEDIFF('year', e.INSTALLATION_DATE, CURRENT_DATE()), 0) * 100 as LIFETIME_AVAILABILITY
    FROM EQUIPMENT e
    LEFT JOIN WORK_ORDERS wo ON e.EQUIPMENT_ID = wo.EQUIPMENT_ID AND wo.STATUS = 'COMPLETED'
    WHERE e.STATUS = 'ACTIVE'
    AND DATEDIFF('year', e.INSTALLATION_DATE, CURRENT_DATE()) > 0
    GROUP BY e.EQUIPMENT_ID, e.EQUIPMENT_NAME, e.EQUIPMENT_TYPE, e.REPLACEMENT_COST, e.INSTALLATION_DATE
)
SELECT 
    EQUIPMENT_NAME,
    EQUIPMENT_TYPE,
    AGE_YEARS,
    REMAINING_YEARS,
    REPLACEMENT_COST,
    TOTAL_MAINTENANCE_COST,
    ROUND(TOTAL_MAINTENANCE_COST / REPLACEMENT_COST * 100, 2) as MAINTENANCE_TO_REPLACEMENT_RATIO,
    ROUND(LIFETIME_AVAILABILITY, 2) as LIFETIME_AVAILABILITY_PERCENT,
    TOTAL_MAINTENANCE_EVENTS,
    AVG_COST_PER_EVENT,
    TOTAL_DOWNTIME_HOURS,
    -- ROI calculation: (Value Created - Cost) / Cost
    -- Assume equipment generates $10,000 value per year at 100% availability
    ROUND(((LIFETIME_AVAILABILITY / 100 * 10000 * AGE_YEARS) - TOTAL_MAINTENANCE_COST) / 
        NULLIF(TOTAL_MAINTENANCE_COST, 0) * 100, 2) as MAINTENANCE_ROI_PERCENT
FROM equipment_lifecycle
WHERE TOTAL_MAINTENANCE_COST > 0
ORDER BY MAINTENANCE_ROI_PERCENT DESC, LIFETIME_AVAILABILITY_PERCENT DESC;

-- Summary of all business questions covered:
SELECT 'Maintenance Operations Business Analysis Questions Summary' as SECTION;
SELECT '1. Equipment availability trend by type across facilities' as QUESTION;
SELECT '2. Equipment underperforming vs peer group based on MTTR' as QUESTION;
SELECT '3. Failure mode contribution to total maintenance cost' as QUESTION;
SELECT '4. Maintenance cost efficiency by technician level and specialization' as QUESTION;
SELECT '5. Equipment with highest propensity for emergency maintenance' as QUESTION;
SELECT '6. Preventive vs reactive maintenance ratio and cost impact' as QUESTION;
SELECT '7. Technician utilization rate and workload distribution' as QUESTION;
SELECT '8. Maintenance procedures with highest time variance from estimates' as QUESTION;
SELECT '9. Parts with highest consumption rate and inventory turnover' as QUESTION;
SELECT '10. Maintenance cost breakdown by equipment type and age' as QUESTION;
SELECT '11. Equipment approaching maintenance intervals needing scheduling' as QUESTION;
SELECT '12. Failure pattern analysis for predictive maintenance opportunities' as QUESTION;
SELECT '13. Overall equipment effectiveness (OEE) by facility and type' as QUESTION;
SELECT '14. Impact of maintenance timing on equipment performance' as QUESTION;
SELECT '15. ROI of preventive maintenance vs reactive repairs' as QUESTION;
SELECT '16. Supplier value analysis based on reliability and cost' as QUESTION;
SELECT '17. Seasonal maintenance patterns and demand drivers' as QUESTION;
SELECT '18. Maintenance workload forecast for next quarter' as QUESTION;
SELECT '19. Compliance rate for safety procedures and testing' as QUESTION;
SELECT '20. Equipment with best maintenance ROI and lifecycle value' as QUESTION;
